--
title: Trying to look like a standard blog
author: crooney
tags: hakyll, haskell, blog
--

If you look at blogs generated by [hakyll](//jaspervdj.be/hakyll/) you'll find that practically all of them follow a similar pattern to the example blogs on the hakyll site:  the titles of the most recent posts as links on the home page as well as a link to All Posts.  Sometimes they use the description field to add, well, a description. But this isn't the way most blogs in the wild (e.g. wordpress, blogger) work; rather, they have the first one or two paragraphs followed by a jump or "read more".

I wanted to get this working for hakyll.<a name="more"/>

The challenge lies in the way hakyll stores the post, which consists of a plaintext field section with key/value pairs followed by a body in [markdown](//daringfireball.net/projects/markdown).  For example,

    --
    title: Trying to look like a standard blog
    author: crooney
    tags: hakyll, haskell, blog
    --
    
    body text

The solution is to somehow glean the first part of the body and bung it into a description field.  My poor understanding of arrows caused me to take an embarassingly long time to figure out what was going on behind the scenes in hakyll, but, stumbling through the haddock docs like a blind man looting a bazaar for his own portrait^*^, I found the [copyBodyToField](http://jaspervdj.be/hakyll/reference/Hakyll-Web-Page-Metadata.html#v:copyBodyToField) func.  This allows the very simple solution:

    descCompiler :: Compiler (Page String) (Page String)
    descCompiler =  arr $ copyBodyToField "description"
                    >>> arr changeField "description" go 
      where go i = take (min 1000 (simpleSearch "<a name=\"more\"/>" i 0)) i
            simpleSearch _ [] c       = c
            simpleSearch n h@(_:h') c = if (isPrefixOf n h) then c else simpleSearch n h' c+1 

We just make arrows out of the field funcs (arr is to arrows what pure is to applicatives or return is to monads), look for the anchor to jump to, and trim the field.  I'm not entirely sure about the min 1000 bit, which prevents sucking in an entire long post onto the index page, but could leave the description with dangling html.  Perhaps there should be a stripTags in there, but that would leave the prejump on the home page without links or formatting.  I intend just to be conscientous about putting in jumps.

The search function is as simple as can be, but unless compiling a blog on a [Speak&Spell](http://en.wikipedia.org/wiki/Speak_%26_Spell_(toy)) should be plenty fast enough.

The only thing left to do is put our new compiler arrow in the pipeline, and set the html template to use the description field.  Complete code [here](https://github.com/crooney/pbind.git).

I know this is a lot of description for very little code, but wanting to get hakyll to look like a regular blog was my inspiration for starting this blog, and I'm a little disappointed about how much time I spent on [css](2012-12-29-welcome-to.html) and how little on haskell.  I've an idea for the next post that should be more interesting and challenging.  Cheers. 

^*^Anyone, anyone?